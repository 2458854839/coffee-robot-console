<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能茶咖机器人控制中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6D4C41', // 咖啡棕
                        secondary: '#A1887F', // 浅棕
                        accent: '#FFB74D', // 橙色强调
                        light: '#F5F5F5', // 米白
                        dark: '#3E2723'  // 深棕
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .btn-hover {
                @apply transition-transform duration-300 hover:scale-105;
            }
        }
    </style>
</head>
<body class="bg-light font-sans">
    <!-- 顶部导航 -->
    <header class="bg-primary text-white shadow-lg sticky top-0 z-10">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold flex items-center">
                <i class="fa fa-coffee mr-3"></i>智能茶咖机器人
            </h1>
            <div id="connection-status" class="flex items-center space-x-2">
                <span id="status-text" class="font-medium">未连接</span>
                <span id="status-indicator" class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></span>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">
        <!-- 连接设置 -->
        <div class="bg-white rounded-xl p-6 mb-8 shadow-md">
            <h2 class="text-xl font-semibold mb-4 text-dark border-b pb-2"> <i class="fa fa-plug mr-2"></i>连接设置</h2>
            <div class="grid md:grid-cols-4 gap-4 items-end">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">MQTT服务器</label>
                    <input type="text" id="mqtt-server" value="broker.emqx.io" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">端口</label>
                    <input type="number" id="mqtt-port" value="8084" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">路径</label>
                    <input type="text" id="mqtt-path" value="/mqtt" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary">
                </div>
                <div class="flex items-center pb-2">
                     <input id="ssl-checkbox" type="checkbox" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" checked>
                     <label for="ssl-checkbox" class="ml-2 block text-sm font-medium text-gray-700">SSL</label>
                </div>
                <button id="connect-btn" class="w-full bg-primary text-white py-2 px-4 rounded-md btn-hover md:col-start-4">
                    连接设备
                </button>
            </div>
        </div>

        <!-- 设备状态 -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 shadow-md text-center">
                <i class="fa fa-thermometer-half text-red-500 text-3xl mb-2"></i>
                <h3 class="font-semibold text-gray-600">当前水温</h3>
                <p id="temperature" class="text-4xl font-bold text-dark">-- °C</p>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-md text-center">
                <i class="fa fa-tint text-blue-500 text-3xl mb-2"></i>
                <h3 class="font-semibold text-gray-600">当前水位</h3>
                <p id="water-level" class="text-4xl font-bold text-dark">-- %</p>
            </div>
            <div class="bg-white rounded-xl p-6 shadow-md text-center">
                <i class="fa fa-robot text-accent text-3xl mb-2"></i>
                <h3 class="font-semibold text-gray-600">设备状态</h3>
                <p id="device-status" class="text-2xl font-bold text-dark">待机中</p>
            </div>
        </div>

        <!-- 控制面板 -->
        <div class="grid md:grid-cols-2 gap-8">
            <!-- 左侧：饮品制作 -->
            <div class="bg-white rounded-xl p-6 shadow-md">
                <h2 class="text-xl font-semibold mb-6 text-dark border-b pb-2"><i class="fa fa-mug-hot mr-2"></i>饮品制作</h2>
                
                <div class="mb-6">
                    <h3 class="font-medium mb-3 text-gray-800">1. 选择饮品类型</h3>
                    <div class="flex gap-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="drink-type" value="coffee" checked class="w-4 h-4 text-primary focus:ring-primary">
                            <span class="ml-2 font-medium"><i class="fa fa-coffee mr-1"></i> 咖啡</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="drink-type" value="tea" class="w-4 h-4 text-primary focus:ring-primary">
                            <span class="ml-2 font-medium"><i class="fa fa-leaf mr-1"></i> 茶</span>
                        </label>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="font-medium mb-3 text-gray-800">2. 调整参数</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-medium text-gray-700">浓度</label>
                                <span id="strength-value" class="text-sm font-medium bg-primary text-white px-2 py-1 rounded">3</span>
                            </div>
                            <input type="range" id="strength" min="1" max="5" value="3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-secondary">
                        </div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-medium text-gray-700">温度 (°C)</label>
                                <span id="temp-value" class="text-sm font-medium bg-primary text-white px-2 py-1 rounded">85</span>
                            </div>
                            <input type="range" id="temperature-set" min="60" max="95" value="85" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-secondary">
                        </div>
                         <div>
                            <div class="flex justify-between mb-1">
                                <label class="text-sm font-medium text-gray-700">容量 (ml)</label>
                                <span id="volume-value" class="text-sm font-medium bg-primary text-white px-2 py-1 rounded">350</span>
                            </div>
                            <input type="range" id="volume-set" min="100" max="500" step="50" value="350" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-secondary">
                        </div>
                    </div>
                </div>

                <button id="make-drink-btn" class="w-full bg-accent text-white py-3 px-6 rounded-md text-lg font-medium btn-hover">
                    <i class="fa fa-play mr-2"></i> 开始制作
                </button>
            </div>

            <!-- 右侧：功能与日志 -->
            <div class="flex flex-col gap-8">
                 <div class="bg-white rounded-xl p-6 shadow-md">
                    <h2 class="text-xl font-semibold mb-4 text-dark border-b pb-2"><i class="fa fa-cogs mr-2"></i>设备功能</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="clean-btn" class="bg-secondary text-white py-3 rounded-lg text-center font-medium btn-hover">
                           <i class="fa fa-sync-alt mr-1"></i> 设备清洁
                        </button>
                        <button id="stop-btn" class="bg-gray-600 text-white py-3 rounded-lg text-center font-medium btn-hover">
                           <i class="fa fa-stop-circle mr-1"></i> 紧急停止
                        </button>
                    </div>
                </div>

                <div class="bg-gray-800 rounded-xl p-6 shadow-md flex-grow flex flex-col">
                    <h2 class="text-xl font-semibold mb-4 text-white border-b border-gray-600 pb-2"><i class="fa fa-file-text mr-2"></i>事件日志</h2>
                    <div id="log" class="text-sm text-gray-300 space-y-2 overflow-y-auto h-48 font-mono">
                        <!-- Log messages will be appended here -->
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        // --- DOM Elements ---
        const elements = {
            connectBtn: document.getElementById('connect-btn'),
            serverInput: document.getElementById('mqtt-server'),
            portInput: document.getElementById('mqtt-port'),
            pathInput: document.getElementById('mqtt-path'), // 新增路径输入框
            sslCheckbox: document.getElementById('ssl-checkbox'),
            statusText: document.getElementById('status-text'),
            statusIndicator: document.getElementById('status-indicator'),
            tempDisplay: document.getElementById('temperature'),
            waterLevelDisplay: document.getElementById('water-level'),
            deviceStatusDisplay: document.getElementById('device-status'),
            makeDrinkBtn: document.getElementById('make-drink-btn'),
            cleanBtn: document.getElementById('clean-btn'),
            stopBtn: document.getElementById('stop-btn'),
            logContainer: document.getElementById('log'),
            strengthSlider: document.getElementById('strength'),
            strengthValue: document.getElementById('strength-value'),
            tempSlider: document.getElementById('temperature-set'),
            tempValue: document.getElementById('temp-value'),
            volumeSlider: document.getElementById('volume-set'),
            volumeValue: document.getElementById('volume-value')
        };

        // --- MQTT & State ---
        let client;
        let isConnected = false;
        const cmdTopic = "robot/control";
        const statusTopic = "robot/status";

        // --- UI Update Functions ---
        const updateSliderValue = (slider, display) => {
            display.textContent = slider.value;
        };

        const updateConnectionStatus = (connected) => {
            isConnected = connected;
            elements.statusText.textContent = connected ? '已连接' : '未连接';
            elements.statusIndicator.className = `w-3 h-3 rounded-full ml-2 ${connected ? 'bg-green-500' : 'bg-red-500 animate-pulse'}`;
            elements.connectBtn.innerHTML = connected ? '断开连接' : '连接设备';
            if (connected) {
                elements.connectBtn.classList.replace('bg-primary', 'bg-red-600');
            } else {
                elements.connectBtn.classList.replace('bg-red-600', 'bg-primary');
            }
        };

        const logMessage = (message, type = 'info') => {
            const typeMap = {
                info: { icon: 'fa-info-circle', color: 'text-blue-400' },
                success: { icon: 'fa-check-circle', color: 'text-green-400' },
                error: { icon: 'fa-times-circle', color: 'text-red-400' },
                send: { icon: 'fa-arrow-up', color: 'text-yellow-400' },
                receive: { icon: 'fa-arrow-down', color: 'text-purple-400' }
            };
            const logEntry = document.createElement('div');
            logEntry.className = 'flex items-start';
            logEntry.innerHTML = `
                <i class="fa ${typeMap[type].icon} ${typeMap[type].color} mt-1 mr-2"></i>
                <span class="flex-1">${message}</span>
            `;
            elements.logContainer.appendChild(logEntry);
            elements.logContainer.scrollTop = elements.logContainer.scrollHeight;
        };

        const updateDeviceStatus = (status) => {
            elements.tempDisplay.textContent = `${status.sensors.water_temp.toFixed(1)} °C`;
            elements.waterLevelDisplay.textContent = `${status.sensors.water_level} %`;
            
            const modeMap = {
                standby: '待机中',
                making_coffee: '正在制作咖啡...',
                making_tea: '正在制作茶...',
                cleaning: '设备清洁中...',
                error: '设备故障'
            };
            elements.deviceStatusDisplay.textContent = modeMap[status.mode] || '未知状态';
        };

        // --- Event Listeners ---
        elements.strengthSlider.addEventListener('input', () => updateSliderValue(elements.strengthSlider, elements.strengthValue));
        elements.tempSlider.addEventListener('input', () => updateSliderValue(elements.tempSlider, elements.tempValue));
        elements.volumeSlider.addEventListener('input', () => updateSliderValue(elements.volumeSlider, elements.volumeValue));

        elements.sslCheckbox.addEventListener('change', () => {
            if (elements.sslCheckbox.checked) {
                elements.portInput.value = '8084';
            } else {
                elements.portInput.value = '8083';
            }
        });

        elements.connectBtn.addEventListener('click', () => {
            if (isConnected) {
                if (client) client.end();
            } else {
                connect();
            }
        });

        // --- MQTT Logic ---
        const connect = () => {
            const server = elements.serverInput.value;
            const port = parseInt(elements.portInput.value);
            const path = elements.pathInput.value;
            const useSsl = elements.sslCheckbox.checked;
            const protocol = useSsl ? 'wss' : 'ws';
            const brokerUrl = `${protocol}://${server}:${port}${path}`;
            
            const options = {
                clientId: 'web_console_' + Math.random().toString(16).substr(2, 8),
                clean: true,
                connectTimeout: 4000
            };

            logMessage(`正在连接到 ${brokerUrl}...`, 'info');
            client = mqtt.connect(brokerUrl, options);

            client.on('connect', () => {
                logMessage('MQTT连接成功!', 'success');
                updateConnectionStatus(true);
                client.subscribe(statusTopic, (err) => {
                    if (err) {
                        logMessage(`订阅主题 ${statusTopic} 失败: ${err}`, 'error');
                    } else {
                        logMessage(`已订阅主题: ${statusTopic}`, 'info');
                    }
                });
            });

            client.on('message', (topic, payload) => {
                const message = payload.toString();
                logMessage(`收到消息 [${topic}]: ${message}`, 'receive');
                if (topic === statusTopic) {
                    try {
                        updateDeviceStatus(JSON.parse(message));
                    } catch (e) {
                        logMessage(`无法解析状态JSON: ${e}`, 'error');
                    }
                }
            });

            client.on('error', (err) => logMessage(`连接错误: ${err}`, 'error'));
            client.on('close', () => {
                logMessage('MQTT连接已断开。', 'error');
                updateConnectionStatus(false);
            });
        };
        
        const publishCommand = (payload) => {
            if (!isConnected) {
                alert('请先连接到MQTT服务器。');
                return;
            }
            const jsonPayload = JSON.stringify(payload);
            client.publish(cmdTopic, jsonPayload, (err) => {
                 if (err) {
                    logMessage(`指令发布失败: ${err}`, 'error');
                } else {
                    logMessage(`> [${cmdTopic}]: ${jsonPayload}`, 'send');
                }
            });
        };
        
        elements.makeDrinkBtn.addEventListener('click', () => {
            const drinkType = document.querySelector('input[name="drink-type"]:checked').value;
            publishCommand({
                module: "brew",
                action: "start",
                params: {
                    type: drinkType,
                    strength: parseInt(elements.strengthSlider.value),
                    temperature: parseInt(elements.tempSlider.value),
                    volume: parseInt(elements.volumeSlider.value)
                }
            });
        });
        
        elements.cleanBtn.addEventListener('click', () => {
            publishCommand({ module: "clean", action: "start" });
        });
        
        elements.stopBtn.addEventListener('click', () => {
            publishCommand({ module: "control", action: "stop" });
        });
        
    </script>
</body>
</html>
